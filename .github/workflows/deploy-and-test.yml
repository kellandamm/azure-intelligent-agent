name: Deploy and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: rg-agents-prod
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      app_url: ${{ steps.deploy.outputs.app_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure
      id: deploy
      run: |
        # Deploy using Azure CLI
        deployment_output=$(az deployment group create \
          --name github-${{ github.run_number }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file bicep/main.bicep \
          --parameters bicep/main.bicepparam \
          --query properties.outputs \
          --output json)
        
        app_url=$(echo $deployment_output | jq -r '.webAppUrl.value')
        echo "app_url=$app_url" >> $GITHUB_OUTPUT
        echo "Deployed to: $app_url"
    
    - name: Wait for deployment to stabilize
      run: sleep 30
  
  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Run smoke tests
      id: smoke_test
      run: |
        python tests/smoke_test.py \
          --url ${{ needs.deploy.outputs.app_url }} \
          --skip-auth \
          --json-output smoke-test-results.json
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: smoke-test-results
        path: smoke-test-results.json
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const results = JSON.parse(fs.readFileSync('smoke-test-results.json', 'utf8'));
          
          const status = results.passed ? '✅ PASSED' : '❌ FAILED';
          const body = `## Smoke Test Results ${status}
          
          **Summary:**
          - Total Tests: ${results.total_tests}
          - Passed: ${results.passed_tests}
          - Failed: ${results.failed_tests}
          - Duration: ${results.duration_seconds.toFixed(2)}s
          
          **Application URL:** ${results.base_url}
          
          ${results.failed_tests > 0 ? '**Failed Tests:**\n' + results.results
            .filter(r => !r.passed)
            .map(r => `- ${r.name}: ${r.error_message || 'Failed'}`)
            .join('\n') : ''}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
    
    - name: Fail job if tests failed
      if: always()
      run: |
        if [ "$(jq -r '.passed' smoke-test-results.json)" = "false" ]; then
          echo "Smoke tests failed"
          exit 1
        fi

  security-scan:
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Run OWASP ZAP baseline scan
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: ${{ needs.deploy.outputs.app_url }}
        rules_file_name: '.zap/rules.tsv'
        fail_action: false
    
    - name: Upload ZAP results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: zap-results
        path: report_html.html
